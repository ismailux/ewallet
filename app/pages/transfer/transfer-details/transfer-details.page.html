<!-- src/app/pages/transfer/transfer-details/transfer-details.page.html -->
<ion-header class="ion-no-border custom-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/transfer/mode"></ion-back-button>
    </ion-buttons>
    <ion-title>Enter Transfer Details</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="progress-wrapper">
    <ion-progress-bar value=".5" buffer="1" color="primary" type="determinate"></ion-progress-bar>
    <p class="step-text">Step 2 of 4</p>
  </div>
  <ion-grid>
    <ng-container *ngIf="form">
      <form [formGroup]="form">

        <!-- Amount + Currency -->
        <ion-row>
          <ion-col size="12">
            <div class="field-container">
              <div class="field-label">Amount</div>
              <ion-input formControlName="amount" type="number" fill="clear" placeholder="0.00"
                class="amount-input-field"></ion-input>
              <div class="currency-selector-chip" (click)="openCurrencyModal()">
                <img [src]="selectedCurrency.flag" class="currency-flag" alt="Flag" />
                <span class="currency-name">{{ selectedCurrency.code }}</span>
                <ion-icon name="chevron-down-outline"></ion-icon>
              </div>
            </div>
             <app-field-errors
        [control]="form.get('amount')!"
        fieldName="Amount"
      ></app-field-errors>
          </ion-col>
        </ion-row>

        <!-- Recipient -->
        <ion-row *ngIf="mode==='mobile'">
          <ion-col size="12">
            <div class="field-container">
              <div class="field-label">Recipient</div>
              <div class="field-chip" (click)="isContactModalOpen = true">
                <ion-avatar *ngIf="form.get('recipient')?.value?.avatar">
                  <img [src]="form.get('recipient')?.value?.avatar" [alt]="form.get('recipient')?.value?.name" />
                </ion-avatar>
                <span class="recipient-name">
                  {{ form.get('recipient')?.value?.name || 'Tap to select recipient' }}
                </span>
                <ion-icon name="chevron-down-outline"></ion-icon>
              </div>
            </div>
            <ion-modal [isOpen]="isContactModalOpen" [breakpoints]="[0,0.4,0.8]" [initialBreakpoint]="0.8"
              (willDismiss)="onContactModalDismiss($event.detail)">
              <ng-template>
                <app-select-contact></app-select-contact>
              </ng-template>
            </ion-modal>
             <app-field-errors
        [control]="form.get('recipient')!"
        fieldName="Recipient"
      ></app-field-errors>
          </ion-col>
        </ion-row>

        <!-- Row 3: Category (Mobile only) -->
        <ion-row *ngIf="mode==='mobile'">
          <ion-col size="12">
            <div class="field-container">
              <div class="field-label">Category</div>

              <ion-select formControlName="category" interface="popover" placeholder="Select Category" fill="clear"
                class="category-select">
                <ion-select-option *ngFor="let cat of transferCategories" [value]="cat">{{ cat }}</ion-select-option>
              </ion-select>
            </div>
             <app-field-errors
        [control]="form.get('category')!"
        fieldName="Category"
      ></app-field-errors>
          </ion-col>
        </ion-row>




        <!-- Row 4: Note (Mobile only) -->
        <ion-row *ngIf="mode==='mobile'">
          <ion-col size="12">
            <div class="field-container">

              <!-- static label -->
              <div class="field-label">Note</div>

              <!-- textarea with a combined placeholder -->
              <ion-textarea formControlName="note" placeholder="Enter a note… (Optional)" rows="1"
                class="note-textarea"></ion-textarea>

              <!-- character count -->
              <div class="note-count">
                {{ form.get('note')?.value?.length || 0 }}/50
              </div>
            </div>
          </ion-col>
        </ion-row>



        <!-- Row 5: Schedule (Mobile only) -->
        <ion-row *ngIf="mode==='mobile'">
          <ion-col size="12">
            <div class="field-container">
              <div class="field-label">Schedule</div>

              <!-- One chip: shows 'Now' or the formatted date -->
              <div class="field-chip" (click)="openScheduleModal()">
                {{ form.get('scheduleType')?.value === 'now'
                ? 'Now'
                : (form.get('scheduleDate')?.value | date:'mediumDate')
                }}
                <ion-icon name="chevron-down-outline"></ion-icon>
              </div>
            </div>
          </ion-col>
        </ion-row>

        <ion-modal [isOpen]="isScheduleModalOpen" [breakpoints]="[0,0.4,0.8]" [initialBreakpoint]="0.8"
          (willDismiss)="onScheduleDismiss($event.detail)">
          <ng-template>
            <ion-list>
              <ion-item button (click)="selectSchedule('now')">
                <ion-label>Now</ion-label>
              </ion-item>
              <ion-item button (click)="selectSchedule('date')">
                <ion-label>Pick a date…</ion-label>
              </ion-item>
            </ion-list>

            <ion-content *ngIf="pickedMode==='date'" class="ion-padding">
              <ion-datetime [min]="today" presentation="date" [value]="form.get('scheduleDate')?.value"
                (ionChange)="selectDate($event)" [showDefaultButtons]="false"></ion-datetime>
            </ion-content>
          </ng-template>
        </ion-modal>


        <!-- Cash Pickup Fields -->
        <!-- Cash-Pickup Fields -->
<ng-container *ngIf="mode==='cash'">

  <!-- Pickup Location -->
  <ion-row>
    <ion-col size="12">
      <div class="field-container">
        <div class="field-label">Pickup Location</div>
        <ion-select
          formControlName="pickupLocation"
          interface="popover"
          placeholder="Select location"
          fill="clear"
          class="category-select"
        >
          <ion-select-option value="CashPlus">CashPlus</ion-select-option>
          <ion-select-option value="WesternUnion">Western Union</ion-select-option>
          <ion-select-option value="Wafacash">Wafacash</ion-select-option>
        </ion-select>
      </div>
      <app-field-errors
        [control]="form.get('pickupLocation')!"
        fieldName="Pickup Location"
      ></app-field-errors>
    </ion-col>
  </ion-row>

  <!-- First Name -->
  <ion-row>
    <ion-col size="12">
      <div class="field-container">
        <div class="field-label">First Name</div>
        <ion-input
          formControlName="firstName"
          type="text"
          fill="clear"
          class="field-input"
        ></ion-input>
      </div>
      <app-field-errors
        [control]="form.get('firstName')!"
        fieldName="First Name"
      ></app-field-errors>
    </ion-col>
  </ion-row>

  <!-- Last Name -->
  <ion-row>
    <ion-col size="12">
      <div class="field-container">
        <div class="field-label">Last Name</div>
        <ion-input
          formControlName="lastName"
          type="text"
          fill="clear"
          class="field-input"
        ></ion-input>
      </div>
      <app-field-errors
        [control]="form.get('lastName')!"
        fieldName="Last Name"
      ></app-field-errors>
    </ion-col>
  </ion-row>

  <!-- ID Number -->
  <ion-row>
    <ion-col size="12">
      <div class="field-container">
        <div class="field-label">ID Number</div>
        <ion-input
          formControlName="idNumber"
          type="text"
          fill="clear"
          class="field-input"
        ></ion-input>
      </div>
      <app-field-errors
        [control]="form.get('idNumber')!"
        fieldName="ID Number"
      ></app-field-errors>
    </ion-col>
  </ion-row>

  <!-- City -->
  <ion-row>
    <ion-col size="12">
      <div class="field-container">
        <div class="field-label">City</div>
        <ion-input
          formControlName="city"
          type="text"
          fill="clear"
          class="field-input"
        ></ion-input>
      </div>
      <app-field-errors
        [control]="form.get('city')!"
        fieldName="City"
      ></app-field-errors>
    </ion-col>
  </ion-row>

  <!-- Phone -->
  <ion-row>
    <ion-col size="12">
      <div class="field-container">
        <div class="field-label">Phone</div>
        <ion-input
          formControlName="phone"
          type="tel"
          fill="clear"
          class="field-input"
        ></ion-input>
      </div>
      <app-field-errors
        [control]="form.get('phone')!"
        fieldName="Phone"
      ></app-field-errors>
    </ion-col>
  </ion-row>

  <!-- Email (Optional) -->
  <ion-row>
    <ion-col size="12">
      <div class="field-container">
        <div class="field-label">Email (Optional)</div>
        <ion-input
          formControlName="email"
          type="email"
          fill="clear"
          class="field-input"
        ></ion-input>
      </div>
      <app-field-errors
        [control]="form.get('email')!"
        fieldName="Email"
      ></app-field-errors>
    </ion-col>
  </ion-row>

  <!-- Payment Method -->
  <ion-row>
    <ion-col size="12">
      <div class="field-container">
        <div class="field-label">Payment Method</div>
        <ion-select
          formControlName="paymentMethod"
          interface="popover"
          [interfaceOptions]="{ cssClass: 'wide-popover' }"
          placeholder="Select method"
          fill="clear"
          class="category-select"
        >
          <ion-select-option value="ewallet">eWallet</ion-select-option>
          <ion-select-option value="card">Credit Card</ion-select-option>
        </ion-select>
      </div>
      <app-field-errors
        [control]="form.get('paymentMethod')!"
        fieldName="Payment Method"
      ></app-field-errors>
    </ion-col>
  </ion-row>

</ng-container>

        <!-- Next button -->
          <ion-row>
            <ion-col size="12">
              <ion-button expand="block" color="primary" (click)="proceed()" [disabled]="form.invalid">
                Next
              </ion-button>
            </ion-col>
          </ion-row>
      </form>
    </ng-container>
  </ion-grid>
</ion-content>